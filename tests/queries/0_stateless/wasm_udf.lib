#!/usr/bin/env bash

CUR_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
# shellcheck source=../shell_config.sh
. "$CUR_DIR"/../shell_config.sh

export WASM_TEST_TMP_DIR="${CLICKHOUSE_TMP}/${CLICKHOUSE_TEST_UNIQUE_NAME}"

mkdir -p "${WASM_TEST_TMP_DIR}"

function load_wasm_module()
{
    echo "load_wasm_module::LLVM_VERSION: ${LLVM_VERSION}"

    local TEST_SOURCE_NAME=$1 && shift
    local MODULE_NAME=${1:-$TEST_SOURCE_NAME} && shift

    clang-${LLVM_VERSION} -O3 -std=c23 --target=wasm32 -msimd128 -ffreestanding -nostdlib -Oz -c "${CUR_DIR}/wasm/${TEST_SOURCE_NAME}.c" -o "${WASM_TEST_TMP_DIR}/${TEST_SOURCE_NAME}.o" || exit 1
    wasm-ld-${LLVM_VERSION} --export-all --no-entry --lto-O3 --allow-undefined "${WASM_TEST_TMP_DIR}/${TEST_SOURCE_NAME}.o" -o "${WASM_TEST_TMP_DIR}/${TEST_SOURCE_NAME}.wasm" || exit 1

    cat "${WASM_TEST_TMP_DIR}/${TEST_SOURCE_NAME}.wasm" | ${CLICKHOUSE_CLIENT} --query "
        INSERT INTO system.webassembly_modules (name, code)
        SELECT '${MODULE_NAME}' AS name, raw_blob AS code FROM input('raw_blob String') FORMAT RawBlob" || exit 1
}
